<style type="text/css" media="screen">
    /* Put your CSS styling here */
    thead {
        background-color: #FFC000;
        font-weight: bold;
        text-align: center;
    }

    tfoot {
        font-weight: bold;
    }

    .report-header {
        text-align: center;
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 50px;
    }

    table {
        margin-left: auto;
        margin-right: auto;
        border-collapse: collapse;
        table-layout: fixed;
        width: 100%;
    }

    .headerDescription {
        text-align: center;
        font-weight: bold;
    }

    .title {
        text-align: center;
        font-weight: 500px;
    }

    .parameters {
        text-align: justify;
        font-weight: 300px;
    }
</style>

<script type="text/javascript">

    // Put your javascript functions here

    $(document).ready(function () {
        console.log(dhis2);
        var date = new Date(dhis2.report.date);
        console.log(dhis2.report);
        var orgUnit = dhis2.report.organisationUnit;
        var today = new Date().toLocaleString("pt-PT");


        $("#orgUnit").html(orgUnit.name);
        $("#date").html(date.getDate() + "/" + (date.getMonth() + 1) + "/" + date.getFullYear());
        $("#today").html(today);
        var fullYear = date.getFullYear();
        var month = date.getMonth() + 1;
        var quarter = getQuarter(month);
        var period = fullYear + quarter;

        //Get organisation unit and check the level
        $.get("../api/organisationUnits/" + orgUnit.id + ".json?fields=id,name,level,children", function (json) {
            var level = json.level;
            if (level == 1) {
                let count = json.children.length;
                getReportDetails(json.children, period, count, 1);
            } else if (level == 2) {
                let count = json.children.length;
                getReportDetails(json.children, period, count, 2);
            } else if (level == 3) {
                let count = json.children.length;
                getReportDetails(json.children, period, count, 3);
            } else if (level == 4) {
                $("#orgUnitLevel").html("Unidade Sanitária");
                let validEvaluationsPercentage = 0;
                let percentageOfEvaluationsPerformed = 0;
                let percentageOfEvaluationsPerformedSum = 0;
                const program = "F3ymOKlvuUW";
                const dataDeAvaliacao = "h0R13fKbayt";
                const dataDeAvaliacaoStartDate = date;
                const dataDeAvaliacaoEndDate = new Date(dataDeAvaliacaoStartDate);
                dataDeAvaliacaoEndDate.setDate(dataDeAvaliacaoStartDate.getDate() + 90);
                const enrollAnalytics = "../api/analytics/enrollments/query/" + program
                    + "?dimension=ou:" + orgUnit.id
                    + "&dimension=" + dataDeAvaliacao + ":GE:" + dataDeAvaliacaoStartDate.toISOString().substring(0, 10) + ":LE:" + dataDeAvaliacaoEndDate.toISOString().substring(0, 10)
                    + "&startDate=1970&endDate=9999";
                const tipoDeAvaliacao = "pJPdby9yw6Q:EQ:Linha de Base";
                fetch(enrollAnalytics)
                .then((response) => response.json())
                    .then(function (json) {
                        $("#orgUnit4").html(orgUnit.name);
                        //Numero de Linhas de Base Realizadas
                        var baseline = json.height;
                        $("#baseline").html(baseline);
                        //Percentagem de Linha de base realizadas
                        $("#percentagemLinhaDeBaseRealizada").html(json.height*100);

                    
                        return fetch("../api/organisationUnits/" + orgUnit.id + ".json?fields=id,name,level,openingDate")
                    })
                    .then((response) => response.json())
                    .then((orgUnitDetails) => {
                        // Realizadas a tempo
                        const BASELINE_DAYS = 30;
                        const startDate = new Date(orgUnitDetails.openingDate);
                        const endDate = new Date(orgUnitDetails.openingDate);
                        endDate.setDate(endDate.getDate() + BASELINE_DAYS);

                       const enrollAnalyticsR = "../api/analytics/enrollments/query/" + program
                    + "?dimension=ou:" + orgUnit.id
                    + "&dimension=" + dataDeAvaliacao + ":GE:" + startDate.toISOString().substring(0, 10) + ":LE:" + endDate.toISOString().substring(0, 10)
                    + "&startDate=1970&endDate=9999";

                        
                        return fetch(enrollAnalyticsR)
                    }).then((response ) => response.json())
                    .then (function (json) {
                        $("#realizadasAtempo").html(json.height);
                        $("#percentagemRealizadasAtempo").html(baseline/json.height * 100);
            
                        
                    });
                    $('#tblOrgainzationUnits').append('<tr><td><span id="orgUnit4"></span></td><td><span>1</span></td> <td><span id="baseline"></span></td> <td> <span id="percentagemLinhaDeBaseRealizada"></span>%</td> <td><span id="realizadasAtempo"></span></td> <td><span id="percentagemRealizadasAtempo"></span>%</td></tr>');

            }

        });

        function getQuarter(month) {
            var quarters = ['Janeiro - Março', 'Abril - Junho', 'Julho - Setembro', 'Outubro - Dezembro'];
            if (month == 1 || month == 2 || month == 3) {
                $("#reportPeriod").html(quarters[0] +" de "+ fullYear);
                return 'Q1';
            } else if (month == 4 || month == 5 || month == 6) {
                $("#reportPeriod").html(quarters[1] +" de "+ fullYear);
                return 'Q2';
            } else if (month == 7 || month == 8 || month == 9) {
                $("#reportPeriod").html(quarters[2] +" de "+ fullYear);
                return 'Q3';
            } else if (month == 10 || month == 11 || month == 12) {
                $("#reportPeriod").html(quarters[3] +" de "+ fullYear);
                return 'Q4';
            }
        }
        
        function getOrgUnit(orgUnitId) {

            const orgUnitDetails = fetch("../api/organisationUnits/" + orgUnitId + ".json?fields=id,name,level")
                .then((response) => response.json())
                .then((data) => {
                    return data;
                });

            const printOrgUnitDetails = async () => {
                const a = await orgUnitDetails;
            };

            return printOrgUnitDetails();
        }


        function getReportDetails(orgUnits, period, count, level) {

            var levels = ['Províncias', 'Distritos', 'Unidades Sanitárias']
            if (level == 1) {
                $("#orgUnitLevel").html(levels[0]);
            } else if (level == 2) {
                $("#orgUnitLevel").html(levels[1]);
            } else if (level == 3) {
                $("#orgUnitLevel").html(levels[2]);
            } 

            let expectedEvaluationSum = 0;
            let expectedEvaluationSumPercentage = 0;
            let baselineSum = 0;
            let validEvaluationsSum = 0;
            let validEvaluationSumPercentage = 0;

            $.each(orgUnits, function (index, value) {
                const orgUnitDetails = fetch("../api/organisationUnits/" + value.id + ".json?fields=id,name,children, openingDate")
                    .then((response) => response.json())
                    .then((data) => {
                        this.console(json);
                        this.console(data);
                        this.console (index + ": " + value);
                        return data;
                    });

                const printOrgUnitDetails = async () => {
                    let orgUnitName = "";
                    let baseline = 0;
                    let percentageOfEvaluationsPerformed = 0;
                    let percentageOfEvaluationsPerformedSum = 0;
                    let validEvaluations = 0;
                    let validEvaluationsPercentage = 0;
                    let expectedEvaluations = 0;
                    let orgUnitCount = 0;
                    const a = await orgUnitDetails;
                    $.get("../api/analytics?dimension=dx:yOR81tRBWIw;vA3Y0Bzy4sU;hV52rtgvgEI&dimension=pe:" + period + "&filter=ou:" + value.id, function (json) {
                        if (Array.isArray(json.rows) && json.rows.length > 0) {
                            baseline = json.rows[0][2];
                            validEvaluations = json.rows[1][2];
                            validEvaluationsPercentage = (parseInt(json.rows[2][2]) / parseInt(validEvaluations)) * 100 || 0;

                        }

                        if ((level == 3) || (level == 2)) {
                            if (a.children.length > 0) {
                                orgUnitCount = a.children.length;
                                percentageOfEvaluationsPerformed = ((parseInt(baseline) / parseInt(orgUnitCount)) * 100).toFixed()
                                expectedEvaluationSum = expectedEvaluationSum + orgUnitCount;

                            } else {
                                orgUnitCount = 1;
                                percentageOfEvaluationsPerformed = ((parseInt(baseline) / parseInt(orgUnitCount)) * 100).toFixed()
                                expectedEvaluationSum = expectedEvaluationSum + orgUnitCount;

                            }
                            baselineSum = parseInt(baselineSum) + parseInt(baseline);
                            percentageOfEvaluationsPerformed = ((parseInt(baseline) / parseInt(orgUnitCount)) * 100).toFixed()
                            validEvaluationsSum = parseInt(validEvaluationsSum) + parseInt(validEvaluations);
                            validEvaluationSumPercentage = parseFloat(validEvaluationSumPercentage) + ((parseFloat(validEvaluationsPercentage)) / parseFloat(count));
                            $("#baselineSum").html(baselineSum);
                            $("#expectedEvaluationSum").html(expectedEvaluationSum);
                            $("#percentageOfEvaluationsPerformed").html(percentageOfEvaluationsPerformed);
                            $("#validEvaluationsSum").html(validEvaluationsSum);
                            $("#validEvaluationSumPercentage").html(validEvaluationSumPercentage);
                            $('#tblOrgainzationUnits').append('<tr><td>' + a.name + '</td><td>' + orgUnitCount + '</td>  <td>' + baseline + '</td> <td> ' + percentageOfEvaluationsPerformed + '%</td> <td>' + validEvaluations + '</td> <td>' + validEvaluationsPercentage + '%</td></tr>');
                        } else {
                            let sumFacilities = 0;
                            const orgUnitChildrenDetails = fetch("../api/organisationUnits?fields=id,name,level,children[id,name,level,children[id,name,level]]&filter=parent.id:eq:" + value.id)
                                .then((response) => response.json())
                                .then((data) => {
                                    return data;
                                });
                            const printorgUnitChildrenDetails = async () => {
                                const b = await orgUnitChildrenDetails;
                                b.organisationUnits.forEach(element => {
                                    sumFacilities = sumFacilities + element.children.length;
                                });

                                orgUnitCount = sumFacilities;
                                percentageOfEvaluationsPerformed = parseInt(percentageOfEvaluationsPerformed) + ((parseInt(baseline) / parseInt(sumFacilities)) * 100);

                                expectedEvaluationSum = expectedEvaluationSum + orgUnitCount;
                                baselineSum = parseInt(baselineSum) + parseInt(baseline);
                                validEvaluationsSum = parseInt(validEvaluationsSum) + parseInt(validEvaluations);
                                validEvaluationSumPercentage = parseFloat(validEvaluationSumPercentage) + ((parseFloat(validEvaluationsPercentage)) / parseFloat(count));
                                $("#baselineSum").html(baselineSum);
                                $("#expectedEvaluationSum").html(expectedEvaluationSum);
                                $("#percentageOfEvaluationsPerformed").html(percentageOfEvaluationsPerformed);
                                $("#validEvaluationsSum").html(validEvaluationsSum);
                                $("#validEvaluationSumPercentage").html(validEvaluationSumPercentage.toFixed());
                                $('#tblOrgainzationUnits').append('<tr><td>' + a.name + '</td><td>' + orgUnitCount + '</td> <td>' + baseline + '</td> <td> ' + percentageOfEvaluationsPerformed + '%</td> <td>' + validEvaluations + '</td> <td>' + validEvaluationsPercentage + '%</td></tr>');
                            };
                            printorgUnitChildrenDetails();
                        }
                    });
                };
                printOrgUnitDetails();
            });
            $('#tblTotal').append('<tr><td>Total</td> <td><span id="expectedEvaluationSum"></span></td> <td><span id="baselineSum"></span></td> <td><span id="percentageOfEvaluationsPerformed">%</span></td> <td><span id="validEvaluationsSum"></span></td> <td><span id="validEvaluationSumPercentage"></span>%</td></tr>');
        }
    });

</script>

<div>

    <!-- Put your HTML mark-up here -->
    <header class="report-header">
        <img src="http://nuvem.jembi.org:44981/api/staticContent/logo_front" alt="Emblema">
    </header>
    <p class="headerDescription">República De Moçambique</p>
    <p class="headerDescription">Ministério da Saúde</p>
    <p class="headerDescription">Diração Nacional de Assistência Médica</p>
    <br>
    <p style="text-align: center; font-size: 15px;">INSTRUMENTO ELECTRÓNICO DE MEDIÇÃO DE DESEMPENHO DE SERVIÇOS DE
        CUIDADOS PÓS VIOLÊNCIA BASEADA NO GÉNERO (e- IMD VBG)</p>
    <br>
    <p class="title">Número de Avaliações Linha de Base Realizadas</p>
    <hr>
    <br>
    <p class="parameters"><b>Período de Avaliação:</b> <span id="reportPeriod"></span> </p>

    <table class="table">
        <thead>
            <tr>
                <th rowspan="2" id="orgUnitLevel"></th>
                <th rowspan="2">Avaliações Linha de Base Esperadas (x)</th>
                <th rowspan="2">Avaliações Linha de Base Realizadas (y)</th>
                <th rowspan="2"> % Avaliações Linha de Base Realizadas (y/x)*100</th>
                <th colspan="2"> Avaliações Linha de Base Realizadas a Tempo</th>
            </tr>
            <tr>
                <th>Nº (w)</th>
                <th>%(w/y)*100</th>
            </tr>
        </thead>
        <tbody id="tblOrgainzationUnits">

        </tbody>
        <tfoot id="tblTotal">
        </tfoot>
    </table>
    <p class="parameters"><b>Data de Geração:</b> <span id="today"></span> </p>
</div>