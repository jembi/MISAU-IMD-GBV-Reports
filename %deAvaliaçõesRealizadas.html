<style type="text/css" media="screen">
    /* Put your CSS styling here */
    thead {
        background-color: #FFC000;
        font-weight: bold;
        text-align: center;
    }

    tfoot {
        font-weight: bold;
    }

    .report-header {
        text-align: center;
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 50px;
    }

    table {
        margin-left: auto;
        margin-right: auto;
    }
</style>

<script type="text/javascript">

    // Put your javascript functions here 

    $(document).ready(function () {
        var date = new Date(dhis2.report.date);
        var orgUnit = dhis2.report.organisationUnit;
        var today = new Date();

        console.log(orgUnit);

        $("#orgUnit").html(orgUnit.name);
        $("#date").html(date.getDate() + "/" + (date.getMonth() + 1) + "/" + date.getFullYear());
        $("#today").html(today);
        var fullYear = date.getFullYear();
        var month = date.getMonth() + 1;
        var quarter = getQuarter(month);
        var period = fullYear + quarter;

        //Get organisation unit and check the level
        $.get("../api/organisationUnits/" + orgUnit.id + ".json?fields=id,name,level,children", function (json) {
            var level = json.level;
            if (level == 1) {
                getReportDetails(json.children, period);
            } else if (level == 2) {
                getReportDetails(json.children, period);
            } else if (level == 3) {
                getReportDetails(json.children, period);
            } else if (level == 4) {
                $.get("../api/analytics?dimension=dx:yOR81tRBWIw;u7P0opGH3c9;lD2YLTZ8NOe;QYYFkIdTTDY;vA3Y0Bzy4sU;hV52rtgvgEI&dimension=pe:" + period + "&filter=ou:" + orgUnit.id, function (json) {
                    $("#baseline").html(json.rows[0][2]);
                    $("#internal").html(json.rows[1][2]);
                    $("#external").html(json.rows[2][2]);
                    $("#total").html(json.rows[3][2]);
                    $("#validEvaluations").html(json.rows[4][2]);
                    $("#validEvaluations2").html(json.rows[5][2]);
                    $("#orgUnit4").html(orgUnit.name);

                });
                $('#tblOrgainzationUnits').append('<tr><td><span id="orgUnit4"></span></td><td><span id="baseline"></span></td> <td><span id="internal"></span></td><td><span id="external"></span></td> <td><span id="total"></span></td> <td>1</td> <td>100%</td> <td><span id="validEvaluations"></span></td> <td><span id="validEvaluations2"></span></td></tr>');

            }


            //if level is 1, then get the children of the organisation unit

            //if level is 2, then get the children of the children of the organisation unit

            //if level is 3, then get the children of the children of the children of the organisation unit

            // if level 4, then get the data for the health facility


            // $.get("../api/analytics?dimension=dx:yOR81tRBWIw;u7P0opGH3c9;lD2YLTZ8NOe;QYYFkIdTTDY;vA3Y0Bzy4sU;hV52rtgvgEI&dimension=pe:" + period + "&filter=ou:" + orgUnit.id, function (json) {
            //     $("#baseline").html(json.rows[0][2]);
            //     $("#internal").html(json.rows[1][2]);
            //     $("#external").html(json.rows[2][2]);
            //     $("#total").html(json.rows[3][2]);
            //     $("#validEvaluations").html(json.rows[4][2]);
            //     $("#validEvaluations2").html(json.rows[5][2]);
            // });

            // console.log(date);
            // console.log("Kelvin Murumba");

            // $("#table1").load("../api/reportTables/wjSplEkLewz/data.html?date=" + date);

        });
        function getQuarter(month) {
            if (month == 1 || month == 2 || month == 3) {
                return 'Q1';
            } else if (month == 4 || month == 5 || month == 6) {
                return 'Q2';
            } else if (month == 7 || month == 8 || month == 9) {
                return 'Q3';
            } else if (month == 10 || month == 11 || month == 12) {
                return 'Q4';
            }
        }
        function getOrgUnit(orgUnitId) {
            let results = [];
            let orgUnit = {};
            $.getJSON("../api/organisationUnits/" + orgUnitId + ".json?fields=id,name,level,children", function (data) {
                orgUnit.id = data.id;
                orgUnit.name = data.name;
                orgUnit.level = data.level;
                orgUnit.children = data.children;
                results.push(orgUnit);
                console.log(results);
            });
            return results;
        }

        function getReportDetails(orgUnits, period) {
            let orgUnitName = "";
            let baseline = 0;
            let internal = 0;
            let external = 0;
            let total = 0;
            let validEvaluations = 0;
            let validEvaluationsPercentage = 0;
            let baselineSum = 0;
            let internalSum = 0;
            let externalSum = 0;
            let totalSum = 0;
            let exepectedEvaluationSum = 0;
            let exepectedEvaluationSumPercentage = 0;
            let validEvaluationsSum = 0;
            let validEvaluationSumPercentage = 0;
            $.each(orgUnits, function (index, value) {
                $.get("../api/organisationUnits/" + value.id + ".json?fields=id,name", function (json) {
                    orgUnitName = json.name;
                });

                $.get("../api/analytics?dimension=dx:yOR81tRBWIw;u7P0opGH3c9;lD2YLTZ8NOe;QYYFkIdTTDY;vA3Y0Bzy4sU;hV52rtgvgEI&dimension=pe:" + period + "&filter=ou:" + value.id, function (json) {
                    if (Array.isArray(json.rows) && json.rows.length > 0) {
                        baseline = json.rows[0][2];
                        internal = json.rows[1][2];
                        external = json.rows[2][2];
                        total = json.rows[3][2];
                        validEvaluations = json.rows[4][2];
                        validEvaluationsPercentage = json.rows[5][2];

                    }
                    baselineSum = parseInt(baselineSum) + parseInt(baseline);
                    internalSum = parseInt(internalSum) + parseInt(internal);
                    externalSum = parseInt(externalSum) + parseInt(external);
                    totalSum = parseInt(totalSum) + parseInt(total);
                    exepectedEvaluationSum = parseInt(exepectedEvaluationSum) + parseInt(1)
                    exepectedEvaluationSumPercentage = '100%';
                    validEvaluationsSum = parseInt(validEvaluationsSum) + parseInt(validEvaluations);
                    validEvaluationSumPercentage = 0;
                    $("#baselineSum").html(baselineSum);
                    $("#internalSum").html(internalSum);
                    $("#externalSum").html(externalSum);
                    $("#totalSum").html(totalSum);
                    $("#exepectedEvaluationSum").html(exepectedEvaluationSum);
                    $("#exepectedEvaluationSumPercentage").html(exepectedEvaluationSumPercentage);
                    $("#validEvaluationsSum").html(validEvaluationsSum);
                    $("#validEvaluationSumPercentage").html(validEvaluationSumPercentage);
                    $('#tblOrgainzationUnits').append('<tr><td>' + orgUnitName + '</td><td>' + baseline + '</td> <td>' + internal + '</td><td>' + external + '</td> <td>' + total + '</td> <td>1</td> <td>100%</td> <td>' + validEvaluations + '</td> <td>' + validEvaluationsPercentage + '</td></tr>');

                });
            });
            $('#tblTotal').append('<tr><td>Total</td><td><span id="baselineSum"></span></td><td><span id="internalSum"></span></td><td><span id="externalSum"></span></td> <td><span id="totalSum"></span></td> <td><span id="exepectedEvaluationSum"></span></td> <td>100%</td> <td><span id="validEvaluationsSum"></span></td> <td><span id="validEvaluationSumPercentage"></span></td></tr>');
        }
    });

</script>

<div>

    <!-- Put your HTML mark-up here -->
    <header class="report-header">
        <img src="http://nuvem.jembi.org:44981/api/documents/gAtyR6qt1eC/data" height="80px" alt="Emblema">
        <p>República De Moçambique</p>
        <hr>
        <p>Ministério Da Saúde</p>
        <p>Percentagem de US com avaliações realizadas</p>
    </header>

    <!-- <div class="section" id="table1"></div> -->
    <p style="margin-left: 70px;">
        <b>Período de Avaliação:</b><span id="date"></span>
    </p>
    <p style="margin-left: 70px;">
        <b>Local: </b> <span id="orgUnit"></span>
    </p>
    <table class="table">
        <thead>
            <tr>
                <th rowspan="3">Unidade Sanitária</th>
                <th colspan="3">Tipo de Avalição</th>
                <th rowspan="2">Total</th>
                <th colspan="2">Avaliações Esperadas</th>
                <th colspan="2">Avaliações Realizadas a tempo</th>
            </tr>
            <tr>
                <th>Linha de Base</th>
                <th>Interna</th>
                <th>Externa</th>
                <th>Nº</th>
                <th>%</th>
                <th>Nº </th>
                <th>% </th>
            </tr>
        </thead>
        <tbody id="tblOrgainzationUnits">

        </tbody>
        <tfoot id="tblTotal">
        </tfoot>
    </table>
    <p style="margin-left: 70px;"><b>Data de Geração:</b><span id="today"></span></p>
</div>